"""
VIP Premium Bot - Pakasir QRIS Edition
=======================================

Fitur:
- Pembayaran QRIS via Pakasir.com
- Harga: Rp 250.000 diskon 50% = Rp 125.000
- QR Code langsung di chat (tanpa link)
- Privasi terjamin (admin info tersembunyi)

SETUP:
1. Dapatkan BOT_TOKEN dari @BotFather
2. Daftar di https://app.pakasir.com dan buat Proyek
3. Ambil PAKASIR_SLUG dan PAKASIR_API_KEY dari halaman Proyek
"""

import telebot
from telebot import types
import requests
import json
import os
import io
import uuid
from datetime import datetime, timedelta

# Untuk generate QR Code
try:
    import qrcode
except ImportError:
    print("Installing qrcode library...")
    os.system('pip install qrcode[pil]')
    import qrcode

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KONFIGURASI UTAMA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Bot Token dari @BotFather
BOT_TOKEN = '6613883967:AAGNJ7oJQIbWZ-snY_dqy9rGDw_6nXbUrpY'

# Pakasir.com Configuration
# Dapatkan dari https://app.pakasir.com (halaman detail Proyek)
PAKASIR_SLUG = 'YOUR_PROJECT_SLUG'  # Slug proyek Anda
PAKASIR_API_KEY = 'YOUR_API_KEY'     # API Key proyek Anda

# Link Premium Channel (private invite link)
PREMIUM_LINK = 'https://t.me/+V2JE9sIz35ZmZGNl'

# Admin ID (untuk notifikasi internal saja, tidak ditampilkan ke user)
ADMIN_ID = 6683929810

# Pricing dalam Rupiah
ORIGINAL_PRICE = 250000  # Rp 250.000
DISCOUNT_PERCENT = 50
FINAL_PRICE = int(ORIGINAL_PRICE * (100 - DISCOUNT_PERCENT) / 100)  # Rp 125.000

# Database Files
PREMIUM_DB = 'premium_users.json'
INVOICES_DB = 'pending_invoices.json'

# Pakasir API URLs
PAKASIR_API_URL = 'https://app.pakasir.com/api/transactioncreate/qris'
PAKASIR_CHECK_URL = 'https://app.pakasir.com/api/transactiondetail'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INISIALISASI
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bot = telebot.TeleBot(BOT_TOKEN)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DATABASE HELPERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def load_json(file):
    """Load data dari JSON file"""
    if os.path.exists(file):
        try:
            with open(file, 'r') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_json(file, data):
    """Simpan data ke JSON file"""
    with open(file, 'w') as f:
        json.dump(data, f, indent=2)

# Premium Users
def is_premium(user_id):
    return str(user_id) in load_json(PREMIUM_DB)

def get_premium_data(user_id):
    return load_json(PREMIUM_DB).get(str(user_id))

def add_premium(user_id, order_id):
    data = load_json(PREMIUM_DB)
    data[str(user_id)] = {
        'order_id': order_id,
        'activated': datetime.now().isoformat(),
        'amount': FINAL_PRICE
    }
    save_json(PREMIUM_DB, data)

# Pending Invoices
def get_invoice(user_id):
    return load_json(INVOICES_DB).get(str(user_id))

def save_invoice(user_id, order_id, qr_string, expired_at):
    data = load_json(INVOICES_DB)
    data[str(user_id)] = {
        'order_id': order_id,
        'qr_string': qr_string,
        'expired_at': expired_at,
        'created': datetime.now().isoformat()
    }
    save_json(INVOICES_DB, data)

def remove_invoice(user_id):
    data = load_json(INVOICES_DB)
    if str(user_id) in data:
        del data[str(user_id)]
        save_json(INVOICES_DB, data)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PAKASIR API FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def generate_order_id():
    """Generate unique order ID"""
    timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
    unique = uuid.uuid4().hex[:6].upper()
    return f"VIP{timestamp}{unique}"

def create_pakasir_invoice(user_id):
    """Buat invoice pembayaran via Pakasir API"""
    order_id = generate_order_id()
    
    payload = {
        "project": PAKASIR_SLUG,
        "order_id": order_id,
        "amount": FINAL_PRICE,
        "api_key": PAKASIR_API_KEY
    }
    
    try:
        response = requests.post(
            PAKASIR_API_URL,
            json=payload,
            headers={'Content-Type': 'application/json'},
            timeout=30
        )
        
        if response.status_code == 200:
            data = response.json()
            payment = data.get('payment', {})
            return {
                'success': True,
                'order_id': order_id,
                'qr_string': payment.get('payment_number', ''),
                'total_payment': payment.get('total_payment', FINAL_PRICE),
                'expired_at': payment.get('expired_at', '')
            }
        else:
            return {
                'success': False,
                'error': f'API Error: {response.status_code}'
            }
    except Exception as e:
        return {
            'success': False,
            'error': str(e)
        }

def check_pakasir_payment(order_id):
    """Cek status pembayaran via Pakasir API"""
    params = {
        'project': PAKASIR_SLUG,
        'order_id': order_id,
        'amount': FINAL_PRICE,
        'api_key': PAKASIR_API_KEY
    }
    
    try:
        response = requests.get(
            PAKASIR_CHECK_URL,
            params=params,
            timeout=30
        )
        
        if response.status_code == 200:
            data = response.json()
            transaction = data.get('transaction', {})
            return {
                'success': True,
                'status': transaction.get('status', 'pending'),
                'order_id': transaction.get('order_id', order_id),
                'completed_at': transaction.get('completed_at')
            }
        else:
            return {
                'success': False,
                'status': 'unknown',
                'error': f'API Error: {response.status_code}'
            }
    except Exception as e:
        return {
            'success': False,
            'status': 'error',
            'error': str(e)
        }

def generate_qr_image(qr_string):
    """Generate QR code image from string"""
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=10,
        border=4,
    )
    qr.add_data(qr_string)
    qr.make(fit=True)
    
    img = qr.make_image(fill_color="black", back_color="white")
    
    # Convert to bytes
    img_byte_arr = io.BytesIO()
    img.save(img_byte_arr, format='PNG')
    img_byte_arr.seek(0)
    
    return img_byte_arr

def format_rupiah(amount):
    """Format angka ke format Rupiah"""
    return f"Rp {amount:,.0f}".replace(",", ".")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MESSAGE TEMPLATES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def msg_welcome():
    """Pesan welcome untuk user baru"""
    return f"""
ğŸ¬ *VIP Premium Bot*

Akses *10.000+ video premium* berkualitas tinggi!

âœ¨ *Keuntungan:*
â€¢ Akses eksklusif seumur hidup
â€¢ Update harian & privasi 100%

ğŸ’° *Harga:* ~{format_rupiah(ORIGINAL_PRICE)}~ â†’ *{format_rupiah(FINAL_PRICE)}* (-{DISCOUNT_PERCENT}%)
"""

def msg_welcome_premium():
    """Pesan untuk member premium"""
    return """
ğŸ‰ *Welcome Back, VIP!*

Status: âœ… *PREMIUM LIFETIME*

Klik tombol untuk akses konten ğŸ‘‡
"""

def msg_invoice(order_id, total_payment):
    """Pesan invoice pembayaran"""
    return f"""
ğŸ’³ *Invoice Pembayaran QRIS*

ğŸ“¦ VIP Premium Lifetime
ğŸ’µ Total: *{format_rupiah(total_payment)}*
ğŸ”¢ Order ID: `{order_id}`

*Cara Bayar:*
1ï¸âƒ£ Scan QR Code di atas
2ï¸âƒ£ Bayar dengan aplikasi e-wallet/m-banking
3ï¸âƒ£ Klik "âœ… Verifikasi" setelah bayar

â° Berlaku 30 menit
"""

def msg_success(order_id):
    """Pesan pembayaran sukses"""
    return f"""
âœ… *Pembayaran Berhasil!*

ğŸ‰ Selamat! Kamu sekarang *VIP Member*
â° Durasi: *LIFETIME*

Klik tombol untuk akses premium ğŸ‘‡
"""

def msg_pending(order_id):
    """Pesan menunggu pembayaran"""
    return f"""
â³ *Menunggu Pembayaran*

ğŸ”¢ Order ID: `{order_id}`
ğŸ“Š Status: Belum dibayar

Scan QR Code dan selesaikan pembayaran.
"""

def msg_expired():
    """Pesan invoice expired"""
    return """
âŒ› *Invoice Kadaluarsa*

Buat invoice baru untuk melanjutkan.
"""

def msg_error():
    """Pesan error"""
    return """
âŒ *Terjadi Kesalahan*

Coba lagi atau hubungi support.
"""

def msg_cancelled():
    """Pesan dibatalkan"""
    return """
ğŸš« *Dibatalkan*

Ketik /start untuk memulai kembali.
"""

def msg_status_free():
    """Status user free"""
    return f"""
ğŸ“Š *Status Keanggotaan*

ğŸ”“ Status: *FREE*

Upgrade ke Premium:
â€¢ 10.000+ video
â€¢ Akses lifetime
â€¢ Hanya *{format_rupiah(FINAL_PRICE)}*
"""

def msg_status_premium(data):
    """Status user premium"""
    date = data['activated'][:10]
    return f"""
ğŸ“Š *Status Keanggotaan*

âœ… Status: *PREMIUM*
ğŸ“… Sejak: {date}
â° Durasi: *LIFETIME*
"""

def msg_help():
    """Pesan bantuan"""
    return f"""
ğŸ“š *Bantuan*

/start - Menu utama
/status - Cek keanggotaan
/help - Bantuan

*Cara Beli:*
1. Klik "Beli Premium"
2. Scan QR Code QRIS
3. Bayar via e-wallet/m-banking
4. Verifikasi pembayaran
5. Akses premium!

*Harga:* {format_rupiah(FINAL_PRICE)}
*Metode:* QRIS (GoPay, OVO, DANA, ShopeePay, dll)
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KEYBOARDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def kb_main():
    """Keyboard menu utama"""
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(
        types.InlineKeyboardButton("ğŸ’ Beli Premium", callback_data='buy'),
        types.InlineKeyboardButton("ğŸ“Š Status", callback_data='status'),
        types.InlineKeyboardButton("â“ Bantuan", callback_data='help')
    )
    return kb

def kb_premium():
    """Keyboard untuk premium user"""
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(
        types.InlineKeyboardButton("ğŸ”“ Akses Premium", url=PREMIUM_LINK),
        types.InlineKeyboardButton("ğŸ“Š Status", callback_data='status')
    )
    return kb

def kb_invoice(order_id):
    """Keyboard invoice - tanpa link, hanya verifikasi"""
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(
        types.InlineKeyboardButton("âœ… Verifikasi Pembayaran", callback_data=f'verify_{order_id}'),
        types.InlineKeyboardButton("âŒ Batal", callback_data='cancel')
    )
    return kb

def kb_pending(order_id):
    """Keyboard pending payment"""
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(
        types.InlineKeyboardButton("ğŸ”„ Cek Status Pembayaran", callback_data=f'verify_{order_id}'),
        types.InlineKeyboardButton("ğŸ  Menu", callback_data='menu')
    )
    return kb

def kb_success():
    """Keyboard sukses"""
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("ğŸ”“ Akses Premium", url=PREMIUM_LINK))
    return kb

def kb_retry():
    """Keyboard retry"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(
        types.InlineKeyboardButton("ğŸ”„ Coba Lagi", callback_data='buy'),
        types.InlineKeyboardButton("ğŸ  Menu", callback_data='menu')
    )
    return kb

def kb_back():
    """Keyboard back"""
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("ğŸ  Menu Utama", callback_data='menu'))
    return kb

def kb_status_free():
    """Keyboard status free"""
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(
        types.InlineKeyboardButton("ğŸ’ Upgrade Premium", callback_data='buy'),
        types.InlineKeyboardButton("ğŸ  Menu", callback_data='menu')
    )
    return kb

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BOT HANDLERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@bot.message_handler(commands=['start'])
def cmd_start(message):
    """Handle /start command"""
    user_id = message.from_user.id
    args = message.text.split()
    
    # Deep link handler for paid callback
    if len(args) > 1:
        if args[1] == 'paid' or args[1].startswith('paid_'):
            pending = get_invoice(user_id)
            if pending:
                verify_payment(message.chat.id, pending['order_id'], user_id)
                return
    
    # Check premium status
    if is_premium(user_id):
        bot.send_message(
            message.chat.id,
            msg_welcome_premium(),
            parse_mode='Markdown',
            reply_markup=kb_premium()
        )
    else:
        bot.send_message(
            message.chat.id,
            msg_welcome(),
            parse_mode='Markdown',
            reply_markup=kb_main()
        )

@bot.message_handler(commands=['status'])
def cmd_status(message):
    """Handle /status command"""
    show_status(message.chat.id, message.from_user.id)

@bot.message_handler(commands=['help'])
def cmd_help(message):
    """Handle /help command"""
    bot.send_message(
        message.chat.id,
        msg_help(),
        parse_mode='Markdown',
        reply_markup=kb_back()
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CALLBACK HANDLERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@bot.callback_query_handler(func=lambda c: c.data == 'menu')
def cb_menu(call):
    """Back to menu"""
    user_id = call.from_user.id
    
    if is_premium(user_id):
        bot.edit_message_text(
            msg_welcome_premium(),
            call.message.chat.id,
            call.message.message_id,
            parse_mode='Markdown',
            reply_markup=kb_premium()
        )
    else:
        bot.edit_message_text(
            msg_welcome(),
            call.message.chat.id,
            call.message.message_id,
            parse_mode='Markdown',
            reply_markup=kb_main()
        )
    bot.answer_callback_query(call.id)

@bot.callback_query_handler(func=lambda c: c.data == 'buy')
def cb_buy(call):
    """Handle buy premium - Generate QRIS QR Code"""
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    
    if is_premium(user_id):
        bot.answer_callback_query(call.id, "âœ… Kamu sudah premium!", show_alert=True)
        return
    
    bot.answer_callback_query(call.id, "â³ Membuat QRIS...")
    
    # Delete the old message
    try:
        bot.delete_message(chat_id, call.message.message_id)
    except:
        pass
    
    # Send loading message
    loading_msg = bot.send_message(
        chat_id,
        "â³ *Membuat QR Code QRIS...*",
        parse_mode='Markdown'
    )
    
    try:
        # Create invoice via Pakasir API
        result = create_pakasir_invoice(user_id)
        
        if result['success']:
            order_id = result['order_id']
            qr_string = result['qr_string']
            total_payment = result['total_payment']
            expired_at = result['expired_at']
            
            # Save invoice
            save_invoice(user_id, order_id, qr_string, expired_at)
            
            # Generate QR code image
            qr_image = generate_qr_image(qr_string)
            
            # Delete loading message
            try:
                bot.delete_message(chat_id, loading_msg.message_id)
            except:
                pass
            
            # Send QR code image with caption
            bot.send_photo(
                chat_id,
                qr_image,
                caption=msg_invoice(order_id, total_payment),
                parse_mode='Markdown',
                reply_markup=kb_invoice(order_id)
            )
            
        else:
            # Delete loading message
            try:
                bot.delete_message(chat_id, loading_msg.message_id)
            except:
                pass
            
            error_text = f"âŒ *Gagal membuat invoice*\n\nError: {result.get('error', 'Unknown error')}"
            bot.send_message(
                chat_id,
                error_text,
                parse_mode='Markdown',
                reply_markup=kb_retry()
            )
            
    except Exception as e:
        print(f"Error creating invoice: {e}")
        
        # Delete loading message
        try:
            bot.delete_message(chat_id, loading_msg.message_id)
        except:
            pass
        
        bot.send_message(
            chat_id,
            msg_error(),
            parse_mode='Markdown',
            reply_markup=kb_retry()
        )

@bot.callback_query_handler(func=lambda c: c.data.startswith('verify_'))
def cb_verify(call):
    """Verify payment"""
    order_id = call.data.replace('verify_', '')
    user_id = call.from_user.id
    
    bot.answer_callback_query(call.id, "ğŸ” Memeriksa pembayaran...")
    verify_payment(call.message.chat.id, order_id, user_id, call.message.message_id)

@bot.callback_query_handler(func=lambda c: c.data == 'status')
def cb_status(call):
    """Show status"""
    show_status(call.message.chat.id, call.from_user.id, call.message.message_id)
    bot.answer_callback_query(call.id)

@bot.callback_query_handler(func=lambda c: c.data == 'help')
def cb_help(call):
    """Show help"""
    bot.edit_message_text(
        msg_help(),
        call.message.chat.id,
        call.message.message_id,
        parse_mode='Markdown',
        reply_markup=kb_back()
    )
    bot.answer_callback_query(call.id)

@bot.callback_query_handler(func=lambda c: c.data == 'cancel')
def cb_cancel(call):
    """Cancel payment"""
    user_id = call.from_user.id
    remove_invoice(user_id)
    
    # Try to delete the QR image message
    try:
        bot.delete_message(call.message.chat.id, call.message.message_id)
    except:
        pass
    
    bot.send_message(
        call.message.chat.id,
        msg_cancelled(),
        parse_mode='Markdown',
        reply_markup=kb_back()
    )
    bot.answer_callback_query(call.id)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELPER FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def verify_payment(chat_id, order_id, user_id, msg_id=None):
    """Verify payment status via Pakasir API"""
    try:
        result = check_pakasir_payment(order_id)
        
        if not result['success']:
            text = msg_error()
            kb = kb_retry()
        elif result['status'] == 'completed':
            # Payment successful!
            if not is_premium(user_id):
                add_premium(user_id, order_id)
            remove_invoice(user_id)
            
            text = msg_success(order_id)
            kb = kb_success()
            
            # Notify admin
            notify_admin(user_id, order_id)
            
        elif result['status'] == 'pending' or result['status'] == 'active':
            text = msg_pending(order_id)
            kb = kb_pending(order_id)
        else:
            # Expired, cancelled, or failed
            text = msg_expired()
            kb = kb_retry()
        
        # Handle message update - check if it's a photo or text message
        if msg_id:
            try:
                # Try to delete the photo message and send new text
                bot.delete_message(chat_id, msg_id)
                bot.send_message(
                    chat_id, text,
                    parse_mode='Markdown',
                    reply_markup=kb
                )
            except:
                # If delete fails, try editing caption
                try:
                    bot.edit_message_caption(
                        caption=text,
                        chat_id=chat_id,
                        message_id=msg_id,
                        parse_mode='Markdown',
                        reply_markup=kb
                    )
                except:
                    # Fallback: send new message
                    bot.send_message(
                        chat_id, text,
                        parse_mode='Markdown',
                        reply_markup=kb
                    )
        else:
            bot.send_message(
                chat_id, text,
                parse_mode='Markdown',
                reply_markup=kb
            )
            
    except Exception as e:
        print(f"Error verifying: {e}")
        if msg_id:
            try:
                bot.delete_message(chat_id, msg_id)
            except:
                pass
        bot.send_message(
            chat_id, msg_error(),
            parse_mode='Markdown',
            reply_markup=kb_retry()
        )

def show_status(chat_id, user_id, msg_id=None):
    """Show membership status"""
    if is_premium(user_id):
        data = get_premium_data(user_id)
        text = msg_status_premium(data)
        kb = kb_premium()
    else:
        text = msg_status_free()
        kb = kb_status_free()
    
    if msg_id:
        try:
            bot.edit_message_text(
                text, chat_id, msg_id,
                parse_mode='Markdown',
                reply_markup=kb
            )
        except:
            # If edit fails (e.g., photo message), send new message
            bot.send_message(
                chat_id, text,
                parse_mode='Markdown',
                reply_markup=kb
            )
    else:
        bot.send_message(
            chat_id, text,
            parse_mode='Markdown',
            reply_markup=kb
        )

def notify_admin(user_id, order_id):
    """Notify admin about new payment"""
    try:
        text = f"""
ğŸ”” *Pembayaran Baru!*

ğŸ’° {format_rupiah(FINAL_PRICE)}
ğŸ”¢ Order: `{order_id}`
ğŸ“± Metode: QRIS
â° {datetime.now().strftime('%Y-%m-%d %H:%M')}
"""
        bot.send_message(ADMIN_ID, text, parse_mode='Markdown')
    except:
        pass

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ADMIN COMMANDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@bot.message_handler(commands=['admin'])
def cmd_admin(message):
    """Admin panel"""
    if message.from_user.id != ADMIN_ID:
        return
    
    users = load_json(PREMIUM_DB)
    total = len(users)
    revenue = sum(u.get('amount', 0) for u in users.values())
    
    text = f"""
ğŸ”§ *Admin Panel*

ğŸ‘¥ Premium: {total}
ğŸ’° Revenue: {format_rupiah(revenue)}
ğŸ’µ Price: {format_rupiah(FINAL_PRICE)}
ğŸ“± Gateway: Pakasir QRIS

/testapi - Test Pakasir API
/broadcast <msg> - Broadcast
"""
    bot.send_message(message.chat.id, text, parse_mode='Markdown')

@bot.message_handler(commands=['testapi'])
def cmd_testapi(message):
    """Test Pakasir API connection"""
    if message.from_user.id != ADMIN_ID:
        return
    
    bot.reply_to(message, "ğŸ”„ Testing Pakasir API...")
    
    try:
        # Test by checking a dummy transaction
        params = {
            'project': PAKASIR_SLUG,
            'order_id': 'TEST123',
            'amount': 1000,
            'api_key': PAKASIR_API_KEY
        }
        
        response = requests.get(
            PAKASIR_CHECK_URL,
            params=params,
            timeout=10
        )
        
        if response.status_code in [200, 404]:
            text = f"""
âœ… *Pakasir API Connected*

ğŸ“± Project: {PAKASIR_SLUG}
ğŸŒ Gateway: QRIS
ğŸ’µ Price: {format_rupiah(FINAL_PRICE)}
"""
            bot.send_message(message.chat.id, text, parse_mode='Markdown')
        else:
            bot.send_message(message.chat.id, f"âš ï¸ API Response: {response.status_code}")
            
    except Exception as e:
        bot.send_message(message.chat.id, f"âŒ Error: {str(e)[:100]}")

@bot.message_handler(commands=['broadcast'])
def cmd_broadcast(message):
    """Broadcast message to all premium users"""
    if message.from_user.id != ADMIN_ID:
        return
    
    text = message.text.replace('/broadcast', '').strip()
    if not text:
        bot.reply_to(message, "Usage: /broadcast <message>")
        return
    
    users = load_json(PREMIUM_DB)
    sent = 0
    
    for uid in users.keys():
        try:
            bot.send_message(int(uid), f"ğŸ“¢ *Pengumuman*\n\n{text}", parse_mode='Markdown')
            sent += 1
        except:
            pass
    
    bot.reply_to(message, f"âœ… Broadcast sent to {sent}/{len(users)} users")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEFAULT HANDLER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@bot.message_handler(func=lambda m: True)
def default_handler(message):
    """Handle unknown messages"""
    bot.reply_to(
        message,
        "Ketik /start untuk memulai ğŸ‘†",
        parse_mode='Markdown'
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == '__main__':
    print("â•" * 50)
    print("ğŸ¤– VIP Premium Bot - Pakasir QRIS Edition")
    print("â•" * 50)
    print(f"ğŸ’µ Price: {format_rupiah(FINAL_PRICE)} (was {format_rupiah(ORIGINAL_PRICE)})")
    print(f"ğŸ“± Gateway: Pakasir QRIS")
    print(f"ğŸ”— Project: {PAKASIR_SLUG}")
    print("â•" * 50)
    print("Bot running...")
    print("â•" * 50)
    
    bot.infinity_polling()
